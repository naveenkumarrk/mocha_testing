name: Test Coverage

on:
  pull_request:
    branches: 
      - main
      - develop
  push:
    branches: 
      - main
      - develop

jobs:
  test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    
    outputs:
      coverage_percent: ${{ steps.coverage.outputs.coverage_percent }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}
          restore-keys: ${{ runner.os }}-node-

      - name: Install dependencies
        run: npm ci

      - name: Run tests with coverage
        run: |
          # Run tests and generate coverage
          npm run test:coverage
          
          # Verify coverage files exist
          echo "üìÅ Checking for coverage files..."
          ls -la coverage/ || echo "‚ö†Ô∏è Coverage directory not found"
          
          if [ -f coverage/coverage-summary.json ]; then
            echo "‚úÖ coverage-summary.json found"
            cat coverage/coverage-summary.json
          else
            echo "‚ùå coverage-summary.json NOT found"
            exit 1
          fi

      - name: Extract coverage percentage
        id: coverage
        run: |
          PERCENT=$(node -p "require('./coverage/coverage-summary.json').total.lines.pct" || echo "0")
          echo "coverage_percent=$PERCENT" >> $GITHUB_OUTPUT
          echo "üìä Coverage: $PERCENT%"

      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: |
            coverage/coverage-summary.json
            coverage/lcov.info
          retention-days: 30

      - name: Comment coverage on PR
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: coverage
          message: |
            ## üìä Coverage Report
            
            **Lines Coverage:** **${{ steps.coverage.outputs.coverage_percent }}%**
            
            **Required:** ‚â• 99%
            
            ${{ steps.coverage.outputs.coverage_percent >= 99 && '‚úÖ **Status:** PASSED' || '‚ùå **Status:** FAILED - Coverage below threshold!' }}
            
            ---
            <details>
            <summary>üí° How to improve coverage</summary>
            
            - Add tests for uncovered lines
            - Check for edge cases in your code
            - Review the full coverage report in the artifacts
            </details>

  # Separate job that acts as the merge gate/enforcer
  coverage-gate:
    name: Coverage Enforcement
    runs-on: ubuntu-latest
    needs: test
    if: always()
    permissions:
      contents: read
      pull-requests: write
    
    steps:
      - name: Check coverage threshold
        run: |
          COV="${{ needs.test.outputs.coverage_percent }}"
          THRESHOLD=90
          
          echo "======================================"
          echo "üîí COVERAGE GATE ENFORCEMENT"
          echo "======================================"
          echo "üìä Reported Coverage: $COV%"
          echo "üéØ Required Threshold: $THRESHOLD%"
          echo "======================================"
          
          # Handle empty or invalid coverage
          if [ -z "$COV" ] || [ "$COV" = "null" ]; then
            echo "‚ùå GATE FAILED: Coverage data not available"
            echo "This usually means the test job failed or coverage extraction failed"
            exit 1
          fi
          
          # Validate coverage is a number
          if ! [[ "$COV" =~ ^[0-9]+\.?[0-9]*$ ]]; then
            echo "‚ùå GATE FAILED: Invalid coverage value: $COV"
            exit 1
          fi
          
          # Compare using awk for float comparison
          PASS=$(awk -v cov="$COV" -v thresh="$THRESHOLD" 'BEGIN { print (cov >= thresh) ? "1" : "0" }')
          
          if [ "$PASS" = "1" ]; then
            echo ""
            echo "‚úÖ GATE PASSED: Coverage meets threshold!"
            echo "Coverage: $COV% ‚â• $THRESHOLD%"
            echo "This PR is allowed to merge."
            exit 0
          else
            echo ""
            echo "‚ùå GATE FAILED: Coverage below threshold!"
            echo "Coverage: $COV% < $THRESHOLD%"
            echo ""
            echo "üö´ This PR cannot be merged until coverage reaches $THRESHOLD%"
            echo ""
            echo "To fix:"
            echo "1. Add tests for uncovered code"
            echo "2. Review the coverage report in artifacts"
            echo "3. Push new commits with additional tests"
            exit 1
          fi

      - name: Post gate status
        if: always() && github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: coverage-gate
          message: |
            ## üîí Coverage Gate Status
            
            ${{ needs.test.outputs.coverage_percent >= 99 && '‚úÖ **GATE PASSED** - Merge allowed' || '‚ùå **GATE BLOCKED** - Merge not allowed' }}
            
            Coverage: **${{ needs.test.outputs.coverage_percent }}%** (Required: ‚â• 99%)
