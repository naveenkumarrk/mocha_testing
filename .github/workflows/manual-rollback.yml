name: Manual Rollback

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to rollback'
        required: true
        type: choice
        options:
          - staging
          - production
      rollback_type:
        description: 'Rollback type'
        required: true
        type: choice
        options:
          - last-stable
          - previous-version
          - specific-tag
      git_tag:
        description: 'Git tag (only for specific-tag rollback)'
        required: false
        type: string

jobs:
  manual-rollback:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      
      - run: npm ci
      
      - name: Download Last Stable Deployment
        if: inputs.rollback_type == 'last-stable'
        uses: actions/download-artifact@v4
        with:
          name: stable-${{ inputs.environment }}-deployment
        continue-on-error: true
      
      - name: Checkout Specific Tag
        if: inputs.rollback_type == 'specific-tag' && inputs.git_tag != ''
        run: |
          git checkout tags/${{ inputs.git_tag }}
      
      - name: Execute Rollback
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "üîÑ Initiating manual rollback for ${{ inputs.environment }}"
          echo "Rollback type: ${{ inputs.rollback_type }}"
          
          case "${{ inputs.rollback_type }}" in
            "last-stable")
              if [ -f .last-deployment ]; then
                DEPLOYMENT_ID=$(head -n 1 .last-deployment)
                echo "Rolling back to last stable: $DEPLOYMENT_ID"
                npx wrangler rollback --env ${{ inputs.environment }} --deployment-id "$DEPLOYMENT_ID" || \
                  npx wrangler rollback --env ${{ inputs.environment }}
              else
                echo "No stable deployment found, using standard rollback"
                npx wrangler rollback --env ${{ inputs.environment }}
              fi
              ;;
            
            "previous-version")
              echo "Rolling back to previous version"
              npx wrangler rollback --env ${{ inputs.environment }}
              ;;
            
            "specific-tag")
              if [ ! -z "${{ inputs.git_tag }}" ]; then
                echo "Deploying from tag: ${{ inputs.git_tag }}"
                npx wrangler deploy --env ${{ inputs.environment }}
              else
                echo "::error::No git tag provided for specific-tag rollback"
                exit 1
              fi
              ;;
          esac
      
      - name: Verify Rollback
        env:
          STAGING_URL: ${{ secrets.STAGING_URL }}
          PROD_URL: ${{ secrets.PROD_URL }}
        run: |
          if [ "${{ inputs.environment }}" = "production" ]; then
            TEST_URL="${PROD_URL}"
          else
            TEST_URL="${STAGING_URL}"
          fi
          
          echo "Verifying deployment at: $TEST_URL"
          
          # Wait for deployment to propagate
          sleep 10
          
          # Test health endpoint
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "${TEST_URL}/health")
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ Rollback successful - health check passed"
          else
            echo "::error::‚ö†Ô∏è  Health check returned $HTTP_CODE - please verify manually"
          fi
      
      - name: Create Rollback Record
        uses: actions/github-script@v7
        with:
          script: |
            const label = '${{ inputs.environment }}' === 'production' ? 'production-rollback' : 'staging-rollback';
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Manual Rollback: ${context.payload.inputs.environment} (${context.payload.inputs.rollback_type})`,
              body: `## Manual Rollback Executed
              
              **Environment:** ${context.payload.inputs.environment}
              **Type:** ${context.payload.inputs.rollback_type}
              **Git Tag:** ${context.payload.inputs.git_tag || 'N/A'}
              **Triggered by:** @${context.actor}
              **Workflow Run:** [View Run](${context.payload.repository.html_url}/actions/runs/${context.runId})
              
              This is an automated record of the manual rollback operation.
              `,
              labels: [label, 'manual-intervention', 'rollback']
            })