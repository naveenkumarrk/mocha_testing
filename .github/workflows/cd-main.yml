name: CD Main (Production Deploy)

on:
  push:
    branches: [main]

  # ðŸ”¥ Manual trigger for rollback OR manual deployment
  workflow_dispatch:
    inputs:
      rollback_version:
        description: "Set a version ID to rollback production (leave empty if not rolling back)"
        required: false
        default: ""

permissions:
  contents: write
  pull-requests: write
  actions: write

jobs:

  # ðŸ”¥ If manual rollback ID provided â†’ run rollback job ONLY
  manual-rollback:
    if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.rollback_version != '' }}
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - run: npm ci

      - name: Manual Rollback Production Worker
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "Rolling back production to version: ${{ github.event.inputs.rollback_version }}"
          npx wrangler rollback --env production --to-version ${{ github.event.inputs.rollback_version }}

    # Stop the rest of the pipeline when rollback-only mode runs
    outputs:
      rollback_done: "true"

  # Continue normal deployment IF manual rollback NOT triggered
  create-main-pr:
    needs: manual-rollback
    if: ${{ needs.manual-rollback.outputs.rollback_done != 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Auto create PR for release tracking
        uses: repo-sync/pull-request@v2
        with:
          source_branch: main
          destination_branch: release-history
          pr_title: "Production Deployment Report"
          pr_body: "Auto-created PR for prod deployment tracking."
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  ci-tests:
    needs: create-main-pr
    if: ${{ needs.manual-rollback.outputs.rollback_done != 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - run: npm ci
      - run: npm test

  deploy-prod:
    needs: ci-tests
    if: success()
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - run: npm ci

      - name: Deploy to Production Worker
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: npx wrangler deploy

  smoke-tests:
    needs: deploy-prod
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - run: npm ci
      - name: Run Production Smoke Tests
        env:
          PROD_URL: ${{ secrets.PROD_URL }}
        run: npm run test:smoke

  auto-merge-main-pr:
    needs: smoke-tests
    if: success()
    runs-on: ubuntu-latest
    steps:
      - name: Auto merge the PR created for tracking
        uses: pascalgn/automerge-action@v0.16.4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MERGE_METHOD: squash

  rollback-production:
    needs: smoke-tests
    if: failure()
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - run: npm ci
      - name: Automatic Rollback Production Worker (CI failure)
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "Auto rollback triggered due to failing smoke tests"
          npx wrangler rollback --env production
