name: CD Main (Production Deploy)
on:
  push:
    branches: [main]

jobs:
  create-main-pr:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Auto create PR for release tracking
        uses: repo-sync/pull-request@v2
        with:
          source_branch: main
          destination_branch: release-history
          pr_title: "Production Deployment Report"
          pr_body: "Auto-created PR for prod deployment tracking."
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  ci-tests:
    runs-on: ubuntu-latest
    needs: create-main-pr
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - run: npm ci
      - run: npm test

  deploy-prod:
    runs-on: ubuntu-latest
    needs: ci-tests
    if: success()
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - run: npm ci
      - name: Deploy to Production Worker
        run: npx wrangler deploy --env production
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

  smoke-tests:
    runs-on: ubuntu-latest
    needs: deploy-prod
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - run: npm ci
      - name: Run Production Smoke Tests
        run: npm run test:smoke
        env:
          PROD_URL: ${{ secrets.PROD_URL }}

  auto-merge-main-pr:
    needs: smoke-tests
    if: success()
    runs-on: ubuntu-latest
    steps:
      - name: Auto merge the PR created for tracking
        uses: pascalgn/automerge-action@v0.16.4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MERGE_METHOD: squash

  rollback-production:
    needs: smoke-tests
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - run: npm ci
      - name: Rollback Production Worker
        run: npx wrangler rollback --env production
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}