name: Unit Test CI
on:
  push:
    branches: [ '**' ]
  pull_request:
    branches: [ '**' ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}
          restore-keys: ${{ runner.os }}-node-

      - name: Install dependencies
        run: npm ci

      # This generates coverage + json-summary + lcov
      - name: Run tests with coverage
        run: npx c8 --reporter=lcov --reporter=json-summary --reporter=text npm test
        continue-on-error: false

      # Now both files definitely exist
      - name: Generate HTML report (optional but nice)
        run: npx c8 report --reporter=html

      - name: Upload coverage report as artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/

      - name: Extract coverage percentage
        id: coverage
        run: |
          # Primary: from json-summary (most reliable)
          PERCENT=$(node -p "require('./coverage/coverage-summary.json').total.lines.pct" 2>/dev/null || echo "0")
          # Fallback to parsing lcov.info
          if [ "$PERCENT" = "0" ] || [ -z "$PERCENT" ]; then
            PERCENT=$(grep -h '^LF' coverage/lcov.info | awk '{s+=$1} END {print 100*s/NR}' || echo "0")
          fi
          echo "coverage_percent=$(printf "%.2f" "$PERCENT")" >> $GITHUB_OUTPUT
          echo "Line coverage: $PERCENT%"


      - name: Comment coverage on PR
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          message: |
            # Coverage Report ⚡
            **Lines coverage**: **${{ steps.coverage.outputs.coverage_percent }}%**  
            Required threshold: **≥ 90%** (for PR comment)  
            Enforced minimum in CI: **≥ 99%**  
            ${{ steps.coverage.outputs.coverage_percent >= 99 && '✅ Passed' || '❌ Failed (<99%)' }}
