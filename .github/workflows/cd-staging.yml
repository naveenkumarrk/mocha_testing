name: CD Develop (Staging Deploy)

on:
  push:
    branches: [develop]

jobs:
  deploy-staging:
    runs-on: ubuntu-latest
    environment: staging
    outputs:
      deployment-id: ${{ steps.deploy.outputs.deployment-id }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - run: npm ci
      
      - name: Deploy to Staging Worker
        id: deploy
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          # Deploy and capture output
          OUTPUT=$(npx wrangler deploy --env staging 2>&1)
          echo "$OUTPUT"
          
          # Extract deployment ID if available
          DEPLOYMENT_ID=$(echo "$OUTPUT" | grep -oP 'deployment-id: \K[a-f0-9-]+' || echo "")
          echo "deployment-id=$DEPLOYMENT_ID" >> $GITHUB_OUTPUT
          
          # Store last known good deployment in a file
          echo "$DEPLOYMENT_ID" > .last-good-staging-deployment
      
      - name: Store Last Known Good Deployment
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: last-good-staging-deployment
          path: .last-good-staging-deployment
          retention-days: 30

  integration-tests:
    needs: deploy-staging
    runs-on: ubuntu-latest
    environment: staging
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - run: npm ci
      
      - name: Run Integration Tests
        env:
          STAGING_URL: ${{ secrets.STAGING_URL }}
        run: npm run test:integration

  auto-merge-and-deploy:
    needs: integration-tests
    if: success()
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      actions: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Merge develop into main
        run: |
          git fetch origin main
          git checkout main
          git merge origin/develop --no-ff -m "Auto merge develop â†’ main (post-staging tests)"
          git push origin main

  rollback-staging:
    needs: integration-tests
    if: failure()
    runs-on: ubuntu-latest
    environment: staging
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - run: npm ci
      
      - name: Download Last Known Good Deployment
        uses: actions/download-artifact@v4
        with:
          name: last-good-staging-deployment
        continue-on-error: true
      
      - name: Rollback to Last Known Good Version
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          # Try to get last known good deployment ID
          if [ -f .last-good-staging-deployment ]; then
            LAST_GOOD=$(cat .last-good-staging-deployment)
            echo "Found last known good deployment: $LAST_GOOD"
            
            if [ ! -z "$LAST_GOOD" ]; then
              echo "Rolling back to specific deployment: $LAST_GOOD"
              npx wrangler rollback --env staging --deployment-id "$LAST_GOOD" || npx wrangler rollback --env staging
            else
              echo "No deployment ID found, using standard rollback"
              npx wrangler rollback --env staging
            fi
          else
            echo "No last known good deployment found, using standard rollback"
            npx wrangler rollback --env staging
          fi
      
      - name: Notify Rollback
        if: always()
        run: |
          echo "::error::Staging deployment failed and was rolled back"