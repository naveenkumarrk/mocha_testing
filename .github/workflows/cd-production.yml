name: CD Main (Production Deploy)

on:
  push:
    branches: [main]

jobs:
  deploy-production:
    runs-on: ubuntu-latest
    environment: production
    outputs:
      deployment-id: ${{ steps.deploy.outputs.deployment-id }}
      git-sha: ${{ steps.git-info.outputs.sha }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - run: npm ci
      
      - name: Get Git Info
        id: git-info
        run: |
          echo "sha=${{ github.sha }}" >> $GITHUB_OUTPUT
          echo "short-sha=$(git rev-parse --short ${{ github.sha }})" >> $GITHUB_OUTPUT
      
      - name: Deploy to Production Worker
        id: deploy
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          # Deploy and capture output
          OUTPUT=$(npx wrangler deploy 2>&1)
          echo "$OUTPUT"
          
          # Extract deployment ID
          DEPLOYMENT_ID=$(echo "$OUTPUT" | grep -oP 'deployment-id: \K[a-f0-9-]+' || echo "")
          echo "deployment-id=$DEPLOYMENT_ID" >> $GITHUB_OUTPUT
          
          # Store deployment info
          echo "$DEPLOYMENT_ID" > .last-deployment
          echo "${{ github.sha }}" >> .last-deployment
          echo "$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> .last-deployment
      
      - name: Upload Deployment Info
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: deployment-info-${{ steps.git-info.outputs.short-sha }}
          path: .last-deployment
          retention-days: 90

  smoke-tests:
    needs: deploy-production
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - run: npm ci
      
      - name: Run Production Smoke Tests
        env:
          PROD_URL: ${{ secrets.PROD_URL }}
        run: npm run test:integration

  mark-stable:
    needs: smoke-tests
    if: success()
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Download Deployment Info
        uses: actions/download-artifact@v4
        with:
          name: deployment-info-${{ needs.deploy-production.outputs.git-sha }}
      
      - name: Mark as Stable
        uses: actions/upload-artifact@v4
        with:
          name: stable-production-deployment
          path: .last-deployment
          retention-days: 90
      
      - name: Create Git Tag for Stable Release
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          TAG_NAME="prod-stable-$(date +%Y%m%d-%H%M%S)"
          git tag -a "$TAG_NAME" -m "Stable production deployment"
          git push origin "$TAG_NAME" || echo "Tag push failed, continuing..."

  rollback-production:
    needs: [deploy-production, smoke-tests]
    if: failure()
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - run: npm ci
      
      - name: Download Last Stable Deployment
        uses: actions/download-artifact@v4
        with:
          name: stable-production-deployment
        continue-on-error: true
      
      - name: Intelligent Rollback
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "ðŸ”´ Deployment failed - initiating intelligent rollback"
          
          # Check if we have a last known stable deployment
          if [ -f .last-deployment ]; then
            STABLE_DEPLOYMENT_ID=$(head -n 1 .last-deployment)
            STABLE_SHA=$(sed -n '2p' .last-deployment)
            STABLE_DATE=$(sed -n '3p' .last-deployment)
            
            echo "Found stable deployment:"
            echo "  ID: $STABLE_DEPLOYMENT_ID"
            echo "  SHA: $STABLE_SHA"
            echo "  Date: $STABLE_DATE"
            
            if [ ! -z "$STABLE_DEPLOYMENT_ID" ]; then
              echo "Attempting rollback to stable deployment: $STABLE_DEPLOYMENT_ID"
              npx wrangler rollback --env production --deployment-id "$STABLE_DEPLOYMENT_ID" || {
                echo "Specific rollback failed, trying standard rollback"
                npx wrangler rollback
              }
            else
              echo "No valid deployment ID, using standard rollback"
              npx wrangler rollback
            fi
          else
            echo "No stable deployment found, using standard rollback (goes back 1 version)"
            npx wrangler rollback
          fi
      
      - name: Notify Team
        if: always()
        run: |
          echo "::error::ðŸš¨ PRODUCTION DEPLOYMENT FAILED ðŸš¨"
          echo "::error::Production has been rolled back to last known stable version"
          echo "::error::Failed commit: ${{ github.sha }}"
          echo "::error::Please investigate before redeploying"
      
      - name: Create Issue on Failure
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸš¨ Production Deployment Failed - ${context.sha.substring(0, 7)}`,
              body: `## Production Deployment Failure
              
              **Commit:** ${context.sha}
              **Workflow:** ${context.workflow}
              **Run:** ${context.runNumber}
              
              Production deployment failed smoke tests and was automatically rolled back.
              
              **Action Required:**
              1. Review the failed deployment logs
              2. Fix the issues in a new branch
              3. Test thoroughly in staging
              4. Redeploy when ready
              
              [View Workflow Run](${context.payload.repository.html_url}/actions/runs/${context.runId})
              `,
              labels: ['production', 'deployment-failure', 'critical']
            })
